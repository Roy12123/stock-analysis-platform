name: å¤šç­–ç•¥äº¤é›†åˆ†æ (æ¯æ—¥ 18:30 å°åŒ—æ™‚é–“)

on:
  schedule:
    - cron: '30 10 * * *'  # UTC 10:30 = å°åŒ— 18:30
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£ Python ä¾è³´
        run: |
          cd python
          pip install -r requirements.txt

      - name: åŸ·è¡Œå¤šç­–ç•¥äº¤é›†åˆ†æ
        run: |
          cd python
          python å¤šç­–ç•¥äº¤é›†åˆ†æ.py

      - name: æª¢æŸ¥çµæœ
        run: |
          if [ -f "data/latest/å¤šç­–ç•¥äº¤é›†.csv" ]; then
            echo "=== å¤šç­–ç•¥äº¤é›†åˆ†æçµæœ ==="
            ls -lh data/latest/å¤šç­–ç•¥äº¤é›†.csv
            echo "=== ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨æ•¸é‡ ==="
            tail -n +2 data/latest/å¤šç­–ç•¥äº¤é›†.csv | wc -l
            echo "=== å‰10ç­†è³‡æ–™é è¦½ ==="
            head -11 data/latest/å¤šç­–ç•¥äº¤é›†.csv
          fi

      - name: æäº¤è®Šæ›´åˆ° GitHub
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/latest/å¤šç­–ç•¥äº¤é›†.csv
          git diff --staged --quiet || git commit -m "ğŸ“Š å¤šç­–ç•¥äº¤é›†åˆ†ææ›´æ–° - $(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M')"
          git push || echo "æ²’æœ‰è®Šæ›´éœ€è¦æ¨é€"
