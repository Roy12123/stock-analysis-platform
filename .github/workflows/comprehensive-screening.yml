name: è‚¡ç¥¨ç¶œåˆç¯©é¸ (æ¯æ—¥ 18:00 å°åŒ—æ™‚é–“)

on:
  schedule:
    - cron: '0 10 * * *'  # UTC 10:00 = å°åŒ— 18:00
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write  # å…è¨±æ¨é€åˆ° repository

jobs:
  run-screening:
    runs-on: ubuntu-latest

    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£ Python ä¾è³´
        run: |
          cd python
          pip install -r requirements.txt

      - name: åŸ·è¡Œè‚¡ç¥¨ç¶œåˆç¯©é¸
        env:
          FINMIND_TOKEN: ${{ secrets.FINMIND_TOKEN }}
        run: |
          cd python
          python è‚¡ç¥¨ç¶œåˆç¯©é¸.py

      - name: æ•´ç†è³‡æ–™æª”æ¡ˆ
        run: |
          # ç¢ºä¿ç›®éŒ„å­˜åœ¨
          mkdir -p data/latest
          mkdir -p data/history/$(date +%Y-%m-%d)

          # ç§»å‹•æœ€æ–°è³‡æ–™åˆ° latest ç›®éŒ„
          find python -name "*_å¤–è³‡å¤§é‡è²·è¶….csv" -exec mv {} data/latest/å¤–è³‡å¤§é‡è²·è¶….csv \; || true
          find python -name "*_æŠ•ä¿¡é€£çºŒè²·è¶….csv" -exec mv {} data/latest/æŠ•ä¿¡é€£çºŒè²·è¶….csv \; || true
          find python -name "*_å¼·å‹¢è‚¡ç¯©é¸.csv" -exec mv {} data/latest/å¼·å‹¢è‚¡ç¯©é¸.csv \; || true
          find python -name "*_ç›¤æ•´çªç ´.csv" -exec mv {} data/latest/ç›¤æ•´çªç ´.csv \; || true
          find python -name "*_æ—ç¾¤å€‹è‚¡è³‡æ–™.csv" -exec mv {} data/latest/æ—ç¾¤å€‹è‚¡è³‡æ–™.csv \; || true
          find python -name "*_æ—ç¾¤æ’å.csv" -exec mv {} data/latest/æ—ç¾¤æ’å.csv \; || true

          # è¤‡è£½åˆ°æ­·å²è³‡æ–™ç›®éŒ„
          cp data/latest/*.csv data/history/$(date +%Y-%m-%d)/ || true

          # é¡¯ç¤ºæª”æ¡ˆæ¸…å–®
          echo "=== æœ€æ–°è³‡æ–™ ==="
          ls -lh data/latest/
          echo "=== æ­·å²è³‡æ–™ ==="
          ls -lh data/history/$(date +%Y-%m-%d)/

      - name: æäº¤è®Šæ›´åˆ° GitHub
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/
          git diff --staged --quiet || git commit -m "ğŸ“Š æ›´æ–°è‚¡ç¥¨ç¶œåˆç¯©é¸è³‡æ–™ - $(date +'%Y-%m-%d %H:%M') (å°åŒ—æ™‚é–“: $(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M'))"
          git push || echo "æ²’æœ‰è®Šæ›´éœ€è¦æ¨é€"
